# weather_api.py
# Simple local API for geocoding + Met Éireann forecast retrieval

# here are the steps to setup server locally if needed

# pip install fastapi uvicorn requests
# uvicorn weatherGetter:app --reload
# "weatherGetter" in the line above should be changed to whatever the file name this code is in
"""
These are for testing the functions

Root endpoint: this is where the server is ran
http://127.0.0.1:8000/

Geocode a location: this is where you get the lat/lon by placename
http://127.0.0.1:8000/api/geocode?location=Cork%20City

Weather by location: this is where you get the weather by location
http://127.0.0.1:8000/api/weather_by_location?location=Cork%20City
"""

from fastapi import FastAPI, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import requests

app = FastAPI(title="Met Éireann Weather API Proxy")

# Allow local React dev access (adjust origins if needed)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 1. Geocode a location name using OpenStreetMap ---
def geocode_location(location: str):
    url = f"https://nominatim.openstreetmap.org/search?format=json&q={location}"
    r = requests.get(url, headers={"User-Agent": "WeatherAppDemo/1.0"})
    r.raise_for_status()
    data = r.json()
    if not data:
        return None
    return {"name": data[0]["display_name"], "lat": data[0]["lat"], "lon": data[0]["lon"]}


# --- 2. Fetch Met Éireann forecast data ---
def fetch_forecast(lat, lon):
    url = (
        f"https://api.open-meteo.com/v1/forecast?"
        f"latitude={lat}&longitude={lon}"
        f"&hourly=temperature_2m,precipitation,wind_speed_10m"
        f"&timezone=Europe/Dublin"
    )
    r = requests.get(url, timeout=10)
    r.raise_for_status()
    return r.json()


# --- 3. Endpoint: geocode only ---
@app.get("/api/geocode")
def geocode(location: str = Query(..., description="Place name, e.g. 'Cork City'")):
    result = geocode_location(location)
    if not result:
        raise HTTPException(status_code=404, detail="Location not found")
    return result


# --- 4. Endpoint: weather by lat/lon ---
@app.get("/api/weather")
def get_weather(lat: float, lon: float):
    try:
        data = fetch_forecast(lat, lon)
        return data
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


# --- 5. New Endpoint: weather by location string (for React) ---
@app.get("/api/weather_by_location")
def weather_by_location(location: str = Query(..., description="Place name, e.g. 'Cork City'")):
    geo = geocode_location(location)
    if not geo:
        raise HTTPException(status_code=404, detail="Location not found")

    try:
        weather = fetch_forecast(geo["lat"], geo["lon"])
        return {
            "location": geo["name"],
            "lat": geo["lat"],
            "lon": geo["lon"],
            "weather": weather
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/")
def root():
    return {
        "message": "Met Éireann Weather API Proxy is running.",
        "endpoints": {
            "geocode": "/api/geocode?location=Cork City",
            "weather": "/api/weather?lat=51.9&lon=-8.5",
            "weather_by_location": "/api/weather_by_location?location=Cork City"
        },
    }
